var AudioHandler=function(){function dt(){var f,i,e;events.on("update",wt);try{window.AudioContext=window.AudioContext||window.webkitAudioContext;u=new window.AudioContext}catch(s){alert("Sorry! This browser does not support the Web Audio API. Please use Chrome, Safari or Firefox.");return}for(r=u.createAnalyser(),r.smoothingTimeConstant=.3,r.fftSize=1024,r.connect(u.destination),c=r.frequencyBinCount,nt=Math.floor(c/v),ot=new Uint8Array(c),st=new Uint8Array(c),f=256,i=0;i<f;i++)ft.push(0);e=document.getElementById("audioDebug");n=e.getContext("2d");n.width=g;n.height=y;n.fillStyle="rgb(40, 40, 40)";n.lineWidth=2;n.strokeStyle="rgb(255, 255, 255)";$("#audioDebugCtx").hide();a=n.createLinearGradient(0,0,0,256);a.addColorStop(1,"#330000");a.addColorStop(.75,"#aa0000");a.addColorStop(.25,"#aaaa00");a.addColorStop(0,"#aaaaaa");t=640;o=setInterval(ut,t)}function pt(){e=u.createBufferSource();e.connect(r)}function gt(){w();pt();var n=new XMLHttpRequest;n.open("GET",ControlsHandler.audioParams.sampleURL,!0);n.responseType="arraybuffer";n.onload=function(){u.decodeAudioData(n.response,function(n){rt=n;ht()},function(n){console.log(n)})};n.send()}function ht(){e.buffer=rt;e.loop=!0;e.start(0);tt=!0}function w(){tt=!1;e&&(e.stop(0),e.disconnect());n.clearRect(0,0,g,y)}function ni(){ControlsHandler.audioParams.useMic?(ControlsHandler.audioParams.useSample=!1,fi()):w()}function ti(){ControlsHandler.audioParams.useSample?(gt(),ControlsHandler.audioParams.useMic=!1):w()}function ii(){ControlsHandler.audioParams.showDebug?$("#audioDebug").show():$("#audioDebug").hide()}function ri(n){w();pt();var i=n.dataTransfer.files,t=new FileReader;t.onload=function(n){var t=n.target.result;ui(t)};t.readAsArrayBuffer(i[0])}function ui(n){u.decodeAudioData?u.decodeAudioData(n,function(n){rt=n;ht()},function(n){console.log(n)}):(rt=u.createBuffer(n,!1),ht())}function fi(){w();navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;navigator.getUserMedia?navigator.getUserMedia({audio:!0},function(n){e=u.createBufferSource();r=u.createAnalyser();r.fftSize=1024;r.smoothingTimeConstant=.3;microphone=u.createMediaStreamSource(n);microphone.connect(r);tt=!0},function(n){alert("The following error occured: "+n)}):alert("Could not getUserMedia")}function ei(){(vt=!0,ControlsHandler.audioParams.bpmMode)||events.emit("onBeat")}function ut(){(d=(new Date).getTime(),ControlsHandler.audioParams.bpmMode)&&(NeonShapes.onBPMBeat(),vt=!1)}function wt(){var n,u,i;if(tt){for(r.getByteFrequencyData(ot),r.getByteTimeDomainData(st),n=0;n<c;n++)ct[n]=(st[n]-128)/128*ControlsHandler.audioParams.volSens;for(n=0;n<v;n++){for(u=0,i=0;i<nt;i++)u+=ot[n*nt+i];b[n]=u/nt/256*ControlsHandler.audioParams.volSens}for(u=0,i=0;i<v;i++)u+=b[i];s=u/v;ft.push(s);ft.shift(1);s>l&&s>lt?(ei(),l=s*1.1,it=0):it<=ControlsHandler.audioParams.beatHoldTime?it++:(l*=ControlsHandler.audioParams.beatDecayRate,l=Math.max(l,lt));k=((new Date).getTime()-d)/t;ControlsHandler.audioParams.showDebug&&oi()}}function oi(){var f,t,r,u;for(n.clearRect(0,0,g,y),n.fillStyle="#000",n.fillRect(0,0,g,y),f=p/v,n.fillStyle=a,t=0;t<v;t++)n.fillRect(t*f,i,f-kt,-b[t]*i);for(it<6&&(n.fillStyle="#FFF"),n.fillRect(p,i,yt,-s*i),n.beginPath(),n.moveTo(p,i-l*i),n.lineTo(p+yt,i-l*i),n.stroke(),n.beginPath(),t=0;t<c;t++)n.lineTo(t/c*p,ct[t]*i/2+i/2);n.stroke();r=bt;u=r-k*r;n.fillStyle="#020";n.fillRect(0,i,r,r);n.fillStyle="#0F0";n.fillRect((r-u)/2,i+(r-u)/2,u,u)}function si(){console.log("ontap");clearInterval(o);timeSeconds=new Date;msecs=timeSeconds.getTime();msecs-at>2e3&&(h=0);h===0?(console.log("First Beat"),et=msecs,h=1):(bpmAvg=6e4*h/(msecs-et),t=(msecs-et)/h,h++,console.log("bpm: "+Math.round(bpmAvg*100)/100+" , taps: "+h+" , msecs: "+t),ut(),clearInterval(o),o=setInterval(ut,t));at=msecs}function hi(){switch(ControlsHandler.audioParams.bpmRate){case-3:f=t*8;break;case-2:f=t*4;break;case-1:f=t*2;break;case 0:f=t;break;case 1:f=t/2;break;case 2:f=t/4;break;case 3:f=t/8;break;case 4:f=t/16}k=((new Date).getTime()-d)/t;timeToNextBeat=f-((new Date).getTime()-d);clearInterval(o);o=setInterval(ci,timeToNextBeat)}function ci(){clearInterval(o);o=setInterval(ut,f)}var ct=[],b=[],s=0,k=0,f=550,ft=[],d,lt=.15,h=0,et=0,at=0,t=633,o,vt=!1,n,g=250,y=200,p=220,i=160,yt=30,bt=y-i,kt=2,a,ot,st,v=16,c,nt,tt=!1,l=0,it=0,e,rt,u,r;return{onMP3Drop:ri,onShowDebug:ii,onUseMic:ni,onUseSample:ti,update:wt,init:dt,onTap:si,onChangeBPMRate:hi,getLevelsData:function(){return b},getVolume:function(){return s},getBPMTime:function(){return k}}}();